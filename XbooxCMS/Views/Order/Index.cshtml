@model IEnumerable<XbooxCMS.ViewModels.OrderViewModel>
@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<head>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
</head>

<h2 class="my-3 text-center">所有訂單</h2>
<section class="shop-cart spad">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <div class="shop__cart__table ml-5">
                    <table class="text-center  mdl-data-table mdl-data-table_full mdl-js-data-table mdl-shadow--1dp">
                        <thead>
                            <tr>
                                <th>訂單編號</th>
                                <th>建立人</th>
                                <th>建立日期</th>
                                <th>收件人姓名</th>
                                <th>收件人信箱</th>
                                <th>收件人地址</th>
                                <th>付款狀態</th>
                                <th>訂單明細</th>
                                <th>編輯與刪除</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model)
                            {
                                <tr>
                                    <td>@item.OrderId</td>
                                    <td>@item.UserName</td>
                                    <td>@item.OrderDate</td>
                                    <td>@item.PurchaserName</td>
                                    <td>@item.PurchaserEmail</td>
                                    <td>@item.PurchaserAddress</td>
                                    <td>
                                        @if (!item.Paid)
                                        {
                                            <div class="text-danger">未付款</div>
                                        }
                                        else
                                        {
                                            <div class="text-success">已付款</div>
                                        }

                                    </td>
                                    <td>
                                        <button class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--colored" id="@item.OrderId" data-toggle="modal" data-target="#orderDetails">查看</button>
                                    </td>
                                    <td>
                                        <input type="button" value="編輯" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent" data-toggle="modal" data-target="#editOrder">
                                        <input type="button" value="刪除" id="@item.OrderId" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent" data-toggle="modal" data-target="#deleteOrder">
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</section>
<div class="modal fade" id="orderDetails" data-backdrop="static" data-keyboard="false" tabindex="-1" aria-labelledby="details" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content"> 
            <div class="modal-header">
                <h5 class="modal-title m-2" id="details">訂單明細</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <table class="table">
                    <thead>
                        <tr>
                            @*<td class="text-center">圖片</td>*@
                            <td style="width: 60%;" >名稱</td>
                            <td>單價</td>
                            <td>數量</td>
                            <td class="text-right">價格</td>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<template id="OrderDetailsList">
    <td style="width: 60%;" ></td>
    <td></td>
    <td></td>
    <td class="text-right"></td>
</template>
<script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>
<script src="https://cdn.jsdelivr.net/npm/promise-polyfill"></script>
<script>
    window.addEventListener("load", function () {
        let detailsBtn = $("button[data-target='#orderDetails']");
        let detailsBody = $("#orderDetails .modal-body tbody");
        let editBtn = $("input[data-target='#editOrder']");
        let deleteBtn = $("input[data-target='#deleteOrder']");
        detailsBtn.on("click", function () {
            $.ajax({
                url: `Order/Detail/${this.id}`,
                method: "get",
                dataType: "json",
                success: function (res) {
                    let total = 0
                    detailsBody.text('');
                    res.forEach(item => {
                        let tr = $("<tr></tr>");
                        let OrderDetailsList = $($("#OrderDetailsList").html());
                        let values = Object.values(item);
                        for (let i = 1; i < values.length; i++) {
                            //OrderDetailsList.eq(0).children("img").attr("src", `/Assets/Image/Pics/${values[0]}.jpg`);
                            OrderDetailsList.eq(2 * (i - 1)).text(values[i]);
                        }
                        total += parseInt(values[values.length - 1]);
                        tr.append(OrderDetailsList);
                        detailsBody.append(tr);
                    })
                    let endtr = $(`<tr><td colspan="4"><span class="d-inline-block w-50 font-weight-bold">總額</span><span style="font-size: 20px" class="d-inline-block w-50 text-right text-danger font-weight-bold">${total}</span></td></tr>`);
                    detailsBody.append(endtr);
                },
                error: function (err) { console.log(err) },
            });
        });

        editBtn.on("click", function () {
            let checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            Swal.fire({
                title: '編輯付款狀態',
                input: 'radio',
                showCancelButton: true,
                confirmButtonText: '確認',
                showLoaderOnConfirm: true,
                inputOptions: {
                    '0': '未付款',
                    '1': '已付款',
                },
                preConfirm: (state) => {
                    return $.ajax({
                        type: "POST",
                        url: "/Order/ChangeState",
                        data: `{ id: ${state}}`,
                        contentType: "application/json; charset=utf-8",
                        dataType: "json",
                        success: function (r) {
                            if (!response.ok) {
                                throw new Error(response.statusText)
                            }
                            return response.json()
                        }
                    });
                },
                allowOutsideClick: () => !Swal.isLoading()
            }).then((result) => {
                if (result.value) {
                    Swal.fire({
                        title: `${result.value.login}'s avatar`,
                        imageUrl: result.value.avatar_url
                    })
                }
            })
        });
        deleteBtn.on("click", function () {
            Swal.fire({
                title: '取消訂單',
                text: "取消訂單後就無法返回",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: '刪除!',
                preConfirm: () => {
                    $.ajax({
                        type: "post",
                        url: `CancelOrder?orderId=${this.id}`,
                        data: "{}",
                        contentType: "application/json; charset=utf-8",
                        dataType: "json",
                        success: function (response) {
                            window.location.href = response.redirectToUrl;
                        }
                    })
                },
                allowOutsideClick: () => !Swal.isLoading()
            })
        });
    });
</script>